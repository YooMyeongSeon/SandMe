<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>장바구니 목록</title>
<link rel="stylesheet" href="./css/style_base.css"> <!-- 베이스 스타일 시트 -->
<link rel="stylesheet" href="./css/style_main.css"> <!-- 메인 스타일 시트 -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> <!-- 제이쿼리 -->
</head>
<body>
<th:block th:replace="fragments/header :: headerFragment"></th:block>	



<br><br><br><br><br><br>

<section>
		<H1>장바구니</H1>
		
		<div th:if="${cartNullChk == 'nothing'}">
			<p>장바구니가 비어있습니다.</p>
			<input type="button" value="메뉴 추가" th:onclick="<!-- memberNum을 가지고 메뉴 선택 페이지로 이동 -->">
		</div>

		
		<div th:unless="${cartNullChk == 'nothing'}">
			장바구니 수량이 비어있지 않을 때
			<form action="cart/insertOrder" method="get">
				<table border="1">
		         	<tr>
		        		<th> <input type="checkbox" name="all" id="all" onclick="itemSum()" th:data-sum="${cartList[0].menuPrice}"> 전체 선택 </th>
		        		<th>메뉴 이름-메뉴 테이블</th>
		                <th>커스텀 정보 - 카트 테이블</th>
		                <th>주소 - 카트 테이블</th> 
		                <th>수량</th>
		                <th>수량 변경시 가격</th>
		                <th>원래 메뉴 가격 - 메뉴 테이블</th>    
		           </tr>
		           <tr th:each="cart : ${cartList}" th:id="'cart'+${cart.cartNum}">
		           		<td>
		           			<input type="checkbox" name="chkNum[]" th:value="${cart.cartNum}" onclick="itemSum()" th:data-sum="${cart.menuPrice}" 
		           				   th:id="chkbox" th:data-cartnum="${cart.cartNum}"> <span th:text="${cart.cartNum}"></span>
		           		</td>
						<td th:text="${cart.menuName}" th:value="${cart.menuName}"></td>
						<td th:text="${cart.custom}" th:value="${cart.custom}"></td>
						<td th:text="${cart.cartAddress}" th:value="${cart.cartAddress}"></td>
						<!-- 장바구니 수량 -->
						<td>
							<input type="button" th:onclick='count("plus")' value="+">
							<div id="result">0</div>
							<input type="button" th:onclick='count("minus")' value="-">
						</td>
						<td>
							<input type="hidden" th:name="price" th:value="${cart.menuPrice}" readonly="readonly">
							<div id="total_price">1</div>
						</td> 
						<td th:text="${cart.menuPrice}" th:value="${cart.menuPrice}"></td> 
					</tr>   	
				</table>
				<br>
				<br>
				<!-- 장바구니 전체 정보 (총 결제 금액, 선택 수량)-->
				<div id="sum_price"> 총 결제 금액 : </div>
				<div id="amount">수량 :</div>
				<input type="submit" value="주문서" th:id="order" th:onclick="order()"> 
				<input type="hidden"  name="memberNum" th:value="${cartList[0].memberNum}">
			</form>
				<br>
			<input type="hidden" th:id="memberNum" th:value="${cartList[0].memberNum}">	
 			<input type="button" value="메뉴 추가" th:onclick="<!-- memberNum을 가지고 메뉴 선택 페이지로 다시 이동 -->">
			<button th:onclick="delcart()">선택 삭제</button>				
		</div> 
		
</section> 
<th:block th:replace="fragments/footer :: footerFragment"></th:block>
	
<script type="text/javascript">


// 선택 상품, 전체 선택 상품 삭제

	 $(function(){
		 let chk = document.getElementById("chkbox");
		 let chkrow = chk.length;
		 
		 // 전체 삭제 체크박스를 누르면 chk_list에 항목 수 만큼 저장
		 $("input[name='all']").click(function(){
			let chk_list = $("#chkbox");
			for(let i=0; i <chk_list.length; i++){
				chk_list[i].checked = this.checked;
			}
		 });
		 
		 // checked 된 delNum의 수가 chkrow의 수와 같다는 건 전체선택 되었다는 것
		 // 따라서, 전체 체크박스도 체크 해줌
		 $("#chkbox").click(function(){
			 if($("#chkbox :checked").length == chkrow){
				 $("input[name='all']")[0].checked = true;
			 }
			 else {
				 $("input[name='all']")[0].checked = false;
			 }
		 });
	 }); 

	// cartNum을 배열로 선언한 후, 그 안에 선택된 체크박스를 list에 담고
	// 선택된 체크박스의 수만큼 cartNum배열에 담는다.
	// ajax를 통해 post방식으로 CartController에 값을 담은 배열 cartNum을 cartNum에 담아 전송
	// 만약 성공했다면 alert("삭제 성공")
	// html에 해당 테이블을 지우기 위해 list의 수만큼 tr에 준 id '#cart' + 배열cartNum에 담긴 요소들을
	// 반복문을 통해 하나씩 꺼내와 삭제한다.
	function delcart(){

		let cartNum = new Array();
		let list = $("#chkbox");
		
		
		for(let i = 0; i < list.length; i++){
			if(list[i].checked){
				cartNum.push(list[i].value);
			}
		}
		//console.log(cartNum);
		
		// 만약에 cartNum의 길이가 0이라면 선택된 항목이 없으므로 alert
		if(cartNum.length==0){
			alert("선택한 메뉴가 없습니다.")
		}else {
			if(confirm("정말 삭제하시겠습니까?")){	
				$.ajax({
					url : "/cart/delete",
					type : "post",
					async : true,
					data : {cartNum : cartNum},
					success : function(result) {
						if(result=1){
							alert("삭제 성공");
							
							for(let i=0; i<list.length; i++){
								$('#cart' + cartNum[i]).remove();
								location.reload();
							}
							
						}
					}
				})
			}else {
				alert("삭제 실패");
			} 
		}  
			
	
	}
	

	// 체크 선택 하면 -> 총 결제 금액 계산
	// 전체체크 박스 체크 여부에 따라 itemSum()으로 이동해 총 결제 금액, 수량 계산
	$("#all").click(function(){
		let chk = $("#all").prop("checked");
		if(chk){
			$("input[name='chkNum[]']").prop("checked",true);
			itemSum();
		} else {
			$("input[name='chkNum[]']").prop("checked",false);
			itemSum();
		}
	})
	
	
	function itemSum(){

		let totalSum = 0;
		let totalCount = $("input[name='chkNum[]']:checked").length;
		
		for(let i = 0; i < totalCount; i++){
			if($("input[name='chkNum[]']:checked")){
				totalSum += parseInt($("input[name='chkNum[]']:checked")[i].dataset.sum);
			}
		}
		$('#sum_price').html("총 결제 금액 : " + totalSum + "원");
		$("#amount").html("수량 : " + totalCount + "개");
		
	}
	

	
	// 체크 박스 체크 여부 alert 창 출력
	$(document).ready(function(){
		$("#order").click(function(){
			if($("input[name='chkNum[]']:checked").is(":checked")){
				return true;
			}else {
				alert("메뉴를 한 개 이상 선택해주세요");
				location.reload();
				return false;
			}
		})
	})
	
	
	// 수량 변경
	function count(type){
		
		const result = document.getElementById('result');
		let count = result.innerText;
		
		
		let eachPrice = 0;
		
		let price  = parseInt($("input[name='price']").val());

		console.log(price);
		
		
		if(type === 'plus'){
			count = parseInt(count)+1;
			for(let i=0; i<=5; i++){
				eachPrice = parseInt(price*count);
				if(count>5){
					alert("최대 주문 수량은 5개 이하입니다.");
					return false;
				}
			}
		}else if(type === 'minus'){
			count = parseInt(count)-1;
			eachPrice -= parseInt(price);
			for(let i=0; i<=5; i++){
				eachPrice = parseInt(price*count);
				if(count<=0){
					alert("최소 주문 수량은 1개 이상입니다.");
					return false;
				}
			}
		}
		
		result.innerText = count;
		$('#total_price').html(eachPrice + "원");
	}
	
	// 수량 변경시 금액 변경
	




</script> 
</body>
</html>



















